var e=(e,o,r)=>new Promise((n,t)=>{var a=e=>{try{i(r.next(e))}catch(o){t(o)}},s=e=>{try{i(r.throw(e))}catch(o){t(o)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,s);i((r=r.apply(e,o)).next())});import{s as o,_ as r,O as n}from"./index-DNox5gY0.js";const t="http://localhost:3001/api",a=()=>navigator.onLine,s={get:o=>e(null,null,function*(){var e,r,s;const i=`${t}${o}`;if(!a()){const e=yield n.get(i,"GET");if(e)return console.log("游닍 Usando cache offline:",o),e;throw new Error("Modo offline: dados n칚o dispon칤veis no cache local.")}try{const e=yield fetch(i,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok){if(0===e.status||503===e.status){const e=yield n.get(i,"GET");if(e)return console.log("游닍 Usando cache devido a erro de servidor:",o),e;const r=t.includes("supabase.co"),a=t.includes("cloudfunctions.net");throw r?new Error("Backend no Supabase n칚o est치 respondendo. Verifique se a Edge Function est치 deployada."):a?new Error("Backend no Firebase n칚o est치 respondendo. Verifique se a Cloud Function est치 deployada."):new Error("Servidor backend n칚o est치 rodando. Verifique se o servidor est치 iniciado na porta 3001.")}throw new Error(`Erro na requisi칞칚o: ${e.status} ${e.statusText}`)}const r=yield e.json();return yield n.set(i,"GET",r),r}catch(d){if((null==(e=d.message)?void 0:e.includes("Failed to fetch"))||(null==(r=d.message)?void 0:r.includes("ERR_CONNECTION_REFUSED"))||(null==(s=d.message)?void 0:s.includes("NetworkError"))||"TypeError"===d.name){const e=yield n.get(i,"GET");if(e)return console.log("游닍 Usando cache devido a erro de rede:",o),e;const r=t.includes("supabase.co"),a=t.includes("cloudfunctions.net");throw r?new Error("N칚o foi poss칤vel conectar ao backend no Supabase. Modo offline ativado - alguns recursos podem estar limitados."):a?new Error("N칚o foi poss칤vel conectar ao backend no Firebase. Modo offline ativado - alguns recursos podem estar limitados."):new Error("Servidor backend n칚o est치 rodando. Modo offline ativado - alguns recursos podem estar limitados.")}throw d}}),post:(o,s)=>e(null,null,function*(){var i,d,l;const c=`${t}${o}`;if(!a()){const{default:n}=yield r(()=>e(null,null,function*(){const{default:e}=yield import("./index-DNox5gY0.js").then(e=>e.q);return{default:e}}),[]);throw n.queueOperation("CREATE","SALES",{endpoint:o,data:s}),new Error("Modo offline: opera칞칚o enfileirada para sincroniza칞칚o quando voltar online.")}try{const e=yield fetch(c,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:s?JSON.stringify(s):void 0});if(!e.ok){if(0===e.status||503===e.status){const e=t.includes("supabase.co"),o=t.includes("cloudfunctions.net");throw e?new Error("Backend no Supabase n칚o est치 respondendo. Verifique se a Edge Function est치 deployada."):o?new Error("Backend no Firebase n칚o est치 respondendo. Verifique se a Cloud Function est치 deployada."):new Error("Servidor backend n칚o est치 rodando. Verifique se o servidor est치 iniciado na porta 3001.")}throw new Error(`Erro na requisi칞칚o: ${e.status} ${e.statusText}`)}const o=yield e.json();return yield n.set(c,"POST",o,s,3e5),o}catch(u){if((null==(i=u.message)?void 0:i.includes("Failed to fetch"))||(null==(d=u.message)?void 0:d.includes("ERR_CONNECTION_REFUSED"))||(null==(l=u.message)?void 0:l.includes("NetworkError"))||"TypeError"===u.name){const{default:n}=yield r(()=>e(null,null,function*(){const{default:e}=yield import("./index-DNox5gY0.js").then(e=>e.q);return{default:e}}),[]);n.queueOperation("CREATE","SALES",{endpoint:o,data:s});const a=t.includes("supabase.co"),i=t.includes("cloudfunctions.net");throw a?new Error("N칚o foi poss칤vel conectar ao backend no Supabase. Opera칞칚o enfileirada para sincroniza칞칚o."):i?new Error("N칚o foi poss칤vel conectar ao backend no Firebase. Opera칞칚o enfileirada para sincroniza칞칚o."):new Error("Servidor backend n칚o est치 rodando. Opera칞칚o enfileirada para sincroniza칞칚o.")}throw u}}),uploadLogo:r=>e(null,null,function*(){try{const e=r.name.split(".").pop(),n=`settings/${`logo-${Math.random().toString(36).substring(2)}.${e}`}`,{error:t}=yield o.storage.from("assets").upload(n,r);if(t)throw t;const{data:{publicUrl:a}}=o.storage.from("assets").getPublicUrl(n),{error:s}=yield o.from("settings").upsert({key:"app_logo_path",value:a,updated_at:(new Date).toISOString()},{onConflict:"key"});if(s)throw s;return{message:"Logo salva com sucesso!",path:a}}catch(e){throw console.error("Error uploading logo to Supabase:",e),new Error(e.message||"Falha no upload da logo.")}}),uploadCertificate:(r,n)=>e(null,null,function*(){try{const e=`certificates/${`certificate-${Date.now()}.pfx`}`,{error:t}=yield o.storage.from("assets").upload(e,r,{cacheControl:"3600",upsert:!0});if(t)throw t;const a=btoa(n),{error:s}=yield o.from("settings").upsert({key:"nfce_cert_password",value:a,updated_at:(new Date).toISOString()},{onConflict:"key"});if(s)throw s;const{error:i}=yield o.from("settings").upsert({key:"nfce_cert_path",value:e,updated_at:(new Date).toISOString()},{onConflict:"key"});if(i)throw i;return{message:"Certificado salvo com sucesso!"}}catch(e){throw console.error("Error uploading certificate:",e),new Error(e.message||"Falha no upload do certificado.")}})};export{s as apiService};
